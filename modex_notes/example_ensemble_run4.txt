# !!! NOTE: The --parm_list includes the PFT number so we need to make sure the file PFT matches the grid cell PFT for each site !!!


export OMPI_MCA_rmaps_base_oversubscribe=1
export OMP_NUM_THREADS=1
export PMIX_MCA_gds=hash

conda activate /data2/sserbin/conda_envs/olmt
module purge
module load hdf5/1.12.1-gcc850 netcdf/4.8.1-gcc850

# US-MMS with MEGAN turned on - Attempting to allow full auto submission (ie. removed the --no-submit option)
python3.9 site_fullrun.py \
--site US-MMS --sitegroup SoutheastUS --caseidprefix SoutheastUS --nyears_ad_spinup 200 \
--nyears_final_spinup 400 --tstep 1 --cpl_bypass --spinup_vars --compiler gnu --mpilib mpi-serial \
--gswp3 --megan --parm_list examples/parm_list_dbf_seus_example \
--mc_ensemble 100 --ng 48 --model_root /data/sserbin/Modeling/FASSt-simulation/E3SM \
--caseroot /data2/Model_Output/olmt_ldrd_simulations \
--runroot /data2/Model_Output/olmt_ldrd_simulations \
--ccsm_input /data/Model_Data/cesm_input_datasets \
--no_submit --machine modex

### OR DO MANUALLY
module purge
export OMPI_MCA_rmaps_base_oversubscribe=1
module load openmpi/4.1.4-gcc850

# submit first job
sbatch -w node03,node02 --ntasks=48 scripts/SoutheastUS/ensemble_run_SoutheastUS_US-MMS_ICB1850CNRDCTCBC_ad_spinup.pbs > temp/jobinfo
# need to get the JOBID from the first submission and place into the next
sjobid=$(cat temp/jobinfo | grep -o -E '[0-9]+')
${sjobid}
sbatch -w node03,node02 --dependency=afterok:${sjobid} --ntasks=48 scripts/SoutheastUS/ensemble_run_SoutheastUS_US-MMS_ICB1850CNPRDCTCBC.pbs > temp/jobinfo
# need to get the JOBID from the second submission and place into the next
sjobid=$(cat temp/jobinfo | grep -o -E '[0-9]+')
${sjobid}
sbatch -w node03,node02 --dependency=afterok:${sjobid} --ntasks=48 scripts/SoutheastUS/ensemble_run_SoutheastUS_US-MMS_ICB20TRCNPRDCTCBC.pbs > temp/jobinfo




#### AUTOMATED DIDNT SEEM TO WORK

### OUTPUT
Parameter ensembles selected:
12 parameters are being modified
100 parameter samples provided


Aliases of cases to be submitted:

['ad_spinup', 'iniadjust', 'fn_spinup', 'transient']

sbatch scripts/SoutheastUS/ensemble_run_SoutheastUS_US-MMS_ICB1850CNRDCTCBC_ad_spinup.pbs > temp/jobinfo
sbatch --dependency=afterok:2094 scripts/SoutheastUS/ensemble_run_SoutheastUS_US-MMS_ICB1850CNPRDCTCBC.pbs > temp/jobinfo
sbatch --dependency=afterok:2095 scripts/SoutheastUS/ensemble_run_SoutheastUS_US-MMS_ICB20TRCNPRDCTCBC.pbs > temp/jobinfo
